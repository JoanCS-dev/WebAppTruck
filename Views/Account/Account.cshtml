@{
  ViewData["Title"] = "Account Management";
}
@section css {
  <style>
    .error{
      color: red;
    }
  </style>
}

@await Html.PartialAsync("~/Views/Dashboard/Dashboard.cshtml")

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Cuentas de Usarios</h1>

        <div class="btn-toolbar mb-2 mb-md-0">

          <div class="btn-group me-2 ">

            <div class="dropdown">
              <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" id="exportDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">Exportar</button>
              <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                <li><a class="dropdown-item" href="#" id="exportExcel">Exportar a Excel</a></li>
                <li><a class="dropdown-item" href="#" id="exportCSV">Exportar a CSV</a></li>
                <li><a class="dropdown-item" href="#" id="exportCopy">Copiar al Portapapeles</a></li>
                <li><a class="dropdown-item" href="#" id="exportPDF">Exportar a PDF</a></li>
                <li><a class="dropdown-item" href="#" id="exportPrint">Imprimir</a></li>
              </ul>
            </div>


          </div>
          <button type="button"
            class="btn btn-sm btn-outline-secondary dropdown-toggle d-flex align-items-center gap-1">
            <svg class="bi">
              <use xlink:href="#calendar3" />
            </svg>
            This week
          </button>
        </div>

      </div>


      <div class="table-responsive small">
        <div class="m-3">
          <button type="button" class="btn btn-success btn-sm" id="AddAccount"><svg xmlns="http://www.w3.org/2000/svg"
              width="20" height="20" fill="currentColor" class="bi bi-person-fill-add" viewBox="0 0 16 16">
              <path
                d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0m-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
              <path
                d="M2 13c0 1 1 1 1 1h5.256A4.5 4.5 0 0 1 8 12.5a4.5 4.5 0 0 1 1.544-3.393Q8.844 9.002 8 9c-5 0-6 3-6 4" />
            </svg> Account</button>
        </div>
        <table class="table table-striped table-hover display nowrap" id="tmain">
          <thead>
            <tr>
              <th>#</th>
              <th>Usuario</th>
              <th>Nombre</th>
              <th>Segundo Nombre</th>
              <th>Apellido</th>
              <th>Correo</th>
              <th>Numero</th>
              <th>Descripcion</th>
              <th>Estatus</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>

          </tbody>
        </table>
      </div>
    </main>
  </div>
</div>

<div class="modal" tabindex="-1" id="modalFinal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="Form">
          <div class="form-group" id="information">
            <input type="hidden" id="id_people_" />
            <input type="hidden" id="id_account" />
            <label>Nombre</label>
            <input type="text" name="nombre" id="nombre" class="form-control" />
            <label>Inicial</label>
            <input type="text" name="inicial" id="inicial" class="form-control" />
            <label>Apellido</label>
            <input type="text" name="apellido" id="apellido" class="form-control" />
            <label>Perfiles</label>
            <select class="form-control" id="ListProfile" name="perfiles">
              <option value="-1">Seleccione</option>
            </select>
          </div>
          <div class="form-group">
            <label>Usuario</label>
            <input type="text" id="user" name="user" class="form-control" />
            <label>Correo</label>
            <input type="text" class="form-control" name="email" id="email" />
            <div id="inpass">

            </div>
            <label>Telefono</label>
            <input type="text" class="form-control" name="number" id="number" />
          </div>
        </form>

      </div>

      <div class="modal-footer">
        <div id="group_btn">

        </div>

        <button type="button" class="btn btn-primary" id="SaveAccount">Continue</button>

      </div>
    </div>
  </div>
</div>


@section JS {

  <script>
    $(function () {
      $(document).ready(function () {
        $.validator.addMethod("noNumeric", function (value, element) {
          return this.optional(element) || !/\d/.test(value);
        }, "Por favor, no ingrese caracteres numéricos.");

        $("#Form").validate({
          rules: {
            nombre: {
              required: true,
              minlength: 3
            },
            inicial: {
              required: true,
              noNumeric: true

            },
            apellido: {
              required: true,
              minlength: 3
            },
            user: {
              required: true,
              minlength: 3
            },
            email: {
              required: true,
              email: true
            },
            
            
            number: {
              number: true,
              minlength: 10,
              maxlength: 12
            },
            perfiles: {
              required: true,
              min: 0
            }

          },
          messages: {
            nombre: {
              required: "Por favor, ingrese su nombre.",
              minlength: "El nombre debe tener al menos 3 caracteres."
            },
            inicial: {
              required: "Por favor, ingrese su inicial.",
              noNumeric: "Por favor, no ingrese caracteres numéricos."
            },
            perfiles: {
              required: "Por favor, seleccione un perfil.",
              min: "Por favor, seleccione un perfil válido."
            },
            apellido: {
              required: "Por favor, ingrese su apellido.",
              minlength: "El apellido debe tener al menos 3 caracteres."
            },
            user: {
              required: "Por favor, ingrese un nombre de usuario.",
              minlength: "El nombre de usuario debe tener al menos 3 caracteres."
            },
            email: {
              required: "Por favor, ingrese su correo electrónico.",
              email: "Por favor, ingrese un correo electrónico válido."
            },
            number : {
              number: "Por favor, ingrese un número válido.",
              minlength: "El número debe tener al menos 10 dígitos.",
              maxlength: "El número debe tener máximo 12 dígitos."
            }
          }
        });

      })


      cargarAccount();

      $("#AddAccount").click(() => {
        cargarProfile();
        console.log("account loaded");

        $("#modalFinal").modal("show");
      });

      $("#SaveAccount").click(() => {

        const data_account = {
          accountDTO: {
            accountID: $("#id_account").val() || 0,
            profileID: $("#ListProfile").val(),
            acUser: $("#user").val(),
            acEmailAddress: $("#email").val(),
            acPhoneNumber: $("#number").val(),
            acPassword: $("#pass").val(),
            acStatus: "Pendiente",
            acRDate: "",
            peopleID: $("#id_people_").val() || 0,
            peFirstName: $("#nombre").val(),
            peMiddleInitial: $("#inicial").val(),
            peLastName: $("#apellido").val(),
            peStatus: "Pendiente",
            peRDate: ""

          }
        };

        $.ajax({
          url: "/Account/AddUpdate",
          data: JSON.stringify(data_account),
          type: "POST",
          dataType: "JSON",
          contentType: "application/json; charset=utf-8;",
          beforeSend: () => {
          },
          success: (res) => {
            if (res.ok) {

              $("#modalFinal").modal("hide");

              const toast = `
                               <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                                  <div class="toast-header">
                                  <strong class="me-auto">Exito</strong>
                                  <small>ALERTA!!</small>
                                      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                  </div>
                                  <div class="toast-body">
                                      ${res.message}
                                  </div>
                              </div>
                                          `;

              $("#Toast_alert").html(toast);
              $(".toast").toast("show");
              cargarAccount();
              limpiarFormulario();
            } else {
              alert(res.message);
            }
          },
          error: () => {
            alert("Ocurrió un error interno, por favor inténtalo más tarde");
          }
        });


      });

    });

    function cargarProfile() {
      $.ajax({
        url: "/Profile/List",
        type: "POST",
        dataType: "JSON",
        contentType: "application/json; charset=utf-8;",
        beforeSend: () => { },
        success: (res) => {
          if (res.ok) {
            console.log(res.data);
            let html = `<option value="-1">Seleccione</option>`;
            $.each(res.data, (index, value) => {
              html += `<option value="${value.profileID}">${value.proDescription}</option>`;
            });
            $("#ListProfile").html(html);
          } else {
            mostrarToast("ALERTA!!", res.message, "alert");
          }
        },
        error: () => {
          alert("Ocurrió un error interno, por favor inténtalo más tarde");
        }
      });
    }
    function cargarAccount() {
      $.ajax({
        url: "/Account/List",
        type: "POST",
        dataType: "JSON",
        contentType: "application/json; charset=utf-8;",
        beforeSend: () => { },
        success: (res) => {
          if (res.ok) {
            console.log(res.data);
            LlenarTabla(res.data);
          } else {
            mostrarToast("ALERTA!!", res.message, "alert");
          }
        },
        error: () => {
          alert("Ocurrió un error interno, por favor inténtalo más tarde");
        }
      });
    }
    var tabla;
    function LlenarTabla(lista) {
      if ($.fn.DataTable.isDataTable("#tmain")) {
        $("#tmain").DataTable().destroy();
      }

      $("#tmain").empty();

      tabla = $("#tmain").DataTable({

        data: lista,
        columns: [
          { data: "accountID" },
          { data: "acUser" },
          { data: "peFirstName" },
          { data: "peMiddleInitial" },
          { data: "peLastName" },
          { data: "acEmailAddress" },
          { data: "acPhoneNumber" },
          { data: "proDescription" },
          { data: "acStatus" },
          { data: "acRDate" },
          {
            data: "accountID",
            render: (value, type, row) => {
              return `<button type='button' class='btn btn-warning m-1' onclick="ShowModalEdit(${value});">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                              </svg>
                          </button>`;
            }
          },
          {
            data: "acStatus",
            render: (value, type, row) => {
              if (value == "Pendiente") {
                return `<button type='button' class='btn btn-success m-1' onclick="Activate(${row.AccountID});">Activate</button>
                                      <input type='hidden' id='id_people_' value='0' />`;
              } else {
                return ``;
              }
            }
          }
        ],

        buttons: [
          'excel', 'csv', 'copy', 'pdf', 'print'
        ],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
        }
      });

    }

    $('#exportExcel').click(function () {
      tabla.button('.buttons-excel').trigger();
      const toast = `
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto">Exito</strong>
              <small>EXCEL</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
             Tu tabla se ha exportado en formato EXCEL exitosamente 
          </div>
      </div>`;
      $("#Toast_alert").html(toast);
      $(".toast").toast("show");
    });


    $('#exportCSV').click(function () {
      tabla.button('.buttons-csv').trigger();
      const toast = `
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto">Exito</strong>
              <small>CSV</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
             Tu tabla se ha exportado en formato CSV exitosamente 
          </div>
      </div>`;
      $("#Toast_alert").html(toast);
      $(".toast").toast("show");
    });


    $('#exportCopy').click(function () {
      const toast = `
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto">Exito</strong>
              <small>Copiar</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
             Tu tabla se ha copiado exitosamente en el portapapeles
          </div>
      </div>`;
      $("#Toast_alert").html(toast);
      $(".toast").toast("show");
      tabla.button('.buttons-copy').trigger();

    });


    $('#exportPDF').click(function () {
      tabla.button('.buttons-pdf').trigger();
      const toast = `
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto">Exito</strong>
              <small>PDF</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
             Tu tabla se ha exportado en formato PDF exitosamente
          </div>
      </div>`;
      $("#Toast_alert").html(toast);
      $(".toast").toast("show");
    });


    $('#exportPrint').click(function () {
      tabla.button('.buttons-print').trigger();
      const toast = `
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto">Exito</strong>
              <small>Imprimir</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
              Tu impresion de la tabla se ha generado con exito!
          </div>
      </div>`;
      $("#Toast_alert").html(toast);
      $(".toast").toast("show");
    });

    function mostrarToast(titulo, mensaje, tipo) {
      const toast = `
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto">${titulo}</strong>
              <small>${tipo}</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
              ${mensaje}
          </div>
      </div>`;
      $("#Toast_alert").html(toast);
      $(".toast").toast("show");
    }
  </script>


}